<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="/home/wuhongyi/CodeProject/ShellAndTemplate/css/wuMarkdownStyle.css" type="text/css" />
</head>
<body>
<!-- README.md --- 
;; 
;; Description: 
;; Author: Hongyi Wu(吴鸿毅)
;; Email: wuhongyi@qq.com 
;; Created: 六 6月 18 13:37:42 2016 (+0800)
;; Last-Updated: 四 7月 21 14:05:04 2016 (+0800)
;;           By: Hongyi Wu(吴鸿毅)
;;     Update #: 41
;; URL: http://wuhongyi.cn -->

<p><strong>本说明书不适用于 Rev-A modules</strong></p>
<hr />
<p>当前完成情况：实验前期获取参数的调节、实验中数据采集、离线数据转换。</p>
<ul>
<li>参数调节：运行程序先获取部分波形 -&gt; 保存数据文件 -&gt; 离线文件调节参数 -&gt; 保存参数文件</li>
<li>数据获取：运行程序（读取调节好的参数） -&gt; 正常获取数据</li>
<li>数据转换：将原始数据转ROOT文件</li>
</ul>
<p>当前时时在线。Trigger Rate监视通过不断I/O从机箱获取。</p>
<p>ROOT文件读取参数文件调用算法查看波形、能量、堆积等信息</p>
<hr />
<h1 id="xia-与-caen-的区别">XIA 与 CAEN 的区别</h1>
<h1 id="xia-的灵活性及其引起的困难">XIA 的灵活性及其引起的困难</h1>
<h2 id="从数据结构及fifo讲起">从数据结构及FIFO讲起</h2>
<p>CAEN 插件在采集波形时，一个插件所有通道每个事件的采样长度只能设置成相同的。 而 XIA 插件可以每个通道单独设置，例如：ch-0 设置采3000个点，ch-1 设置采2000个点，ch-2 设置采5000个点，ch-3 设置成不采集波形……。</p>
<p>在读取数据时候，CAEN 插件每次拿到的数据都是完整事件的数据。 而 XIA 插件 FIFO 的读指针、写指针是独立的、同时进行的，所以每次我们要取数据时候都需要先查询下当前 FIFO 有多少数据，然后再指定该次读取多少数据。因为FIFO读、写是独立的，因而查询到的数据量是该时刻拥有的数据量，这个数据量基本都不是完整事件的数据量（还有部分是当前事件正在写入的）。每个事件除了有 4 words 的 header 及后面紧跟着的数据外并没有事件标记符，当然这样做最大的好处就是速度快。</p>
<h2 id="灵活性带来的困难">灵活性带来的困难</h2>
<p>基于以上事实，两个公司的产品对用户写时时监视获取率、在线监视程序等的实现方式存在较大差异。</p>
<p>CAEN： 由于 CAEN 一个插件上每个通道的采样数相同，因而他们每个事件的长度是一致的。在拿到数据时即可存文件或者 decode 出每个事件的信息用来统计时时获取速率，也可将数据发送到在线程序。</p>
<p>XIA： 由于其上每个通道数据长度可单独设置，这是 XIA 插件的灵活性。又 FIFO 查询到的数据量是当前时刻的数据量，这样每次取到的数据都不是完整事件的数据。</p>
<p>对于多个插件的系统，获取时候一直循环读取每一个插件上的数据，如果将所有插件的数据存在同一个文件内，将造成数据的错乱。如果每个插件的数据单独存在一个文件内，那么下一次读取的该插件的数据中开头的不完整事件的数据刚好接上一次最后一个不完整事件的数据，可解决这个问题。</p>
<p>由于每次拿到的不是完整数据，因此也不好 decode 当前数据来获得每个事件的信息（从开始就decode记录每次数据的不完整事件的情况也可解决该问题，但是这样decode需要额外的时间）。但是 XIA 内部 DSP上统计着信号输入量、获取接收量、活时等信息。可频繁调用函数读取 DSP 上的统计信息来监视时时获取速率。但是频繁调用该函数会对获取的 I/O 有一点影响。</p>
<p>由于每次拿到的不是完整数据，因此共享内存的在线监视也不容易实现，如若要实现，也不是没办法（从开始就decode记录每次数据的不完整事件的情况也可解决该问题，但是这样decode需要额外的时间）。</p>
<p>下面给出一些困难的解决思路： 牺牲XIA插件的灵活性，对一个插件设置成每个通道采集波形长度相同（这样就与CAEN一样了），因为每个通道的每个事件数据的长度相等，读取数据时候查询到当前的数据量之后，然后只读取事件长度整数倍的最大数据，这样每次拿到的都是完整的事件数据了，可参照CAEN的实现方式。</p>
<p>对采波形时候，可采用“伪”在线监视获取情况，即获取文件每隔一段时间保存一次，用上一轮的数据作为“在线”数据。</p>
<h1 id="参数的设置">参数的设置</h1>
<h1 id="软件使用">软件使用</h1>
<p>基线调节有以下两种方式：</p>
<ul>
<li>先到 <strong>Baseline Setup</strong>设置基线百分比，然后到<strong>Analog Signal Setup</strong>按自动调节偏置<strong>AdjustOffset</strong></li>
<li>直接到<strong>Analog Signal Setup</strong>调节<strong>DCOffset</strong></li>
</ul>
<p>基线调节的本质就是调节偏置（DCOffset）</p>
<p><strong>Analog Signal Setup</strong>中的<em>Gain、Sign</em>功能可由<strong>CSRA Register</strong>中的选项<em>TP、EIR</em>代替。</p>
<p>获取时候不可按<strong>Read WF</strong>，不可调节参数，否则获取将自动停止。</p>
<hr />
<!-- 以下参数等新版说明书再整理 -->

<h1 id="user-parameters">User Parameters</h1>
<p>以下参数为 Pixie-16 API 的变量。在大多数情况下，Pixie-16 API 将会调整输入参数到对应于一个有效DSP参数最接近的数值。</p>
<h2 id="system-parameters">System Parameters</h2>
<ul>
<li>NUMBER_MODULES
<ul>
<li>指定该系统中的插件数量，默认范围是 1 - 32。如若超过32个插件，则需要修改pixie16sys_defs.h定义的最大数量。</li>
</ul></li>
<li>OFFLINE_ANALYSIS
<ul>
<li>1表示离线模式，0表示在线模式。</li>
<li>可选参数：0、1</li>
</ul></li>
<li>C_LIBRARY_RELEASE
<ul>
<li>不详</li>
</ul></li>
<li>C_LIBRARY_BUILD
<ul>
<li>输出表示Pixle-16 API 的版本信息。</li>
</ul></li>
<li>PXI_SLOT_MAP
<ul>
<li>用来指定每个插件在机箱的插槽编号。</li>
<li>可选参数： 2 - 14</li>
</ul></li>
</ul>
<h2 id="module-parametersinput">Module Parameters(Input)</h2>
<ul>
<li>MODULE_NUMBER
<ul>
<li>在初始化的为每个插件分配的编号。该编号将写在输出的data header中。</li>
<li>参数范围： 0 - N-1</li>
</ul></li>
<li>MODULE_CSRA
<ul>
<li>控制寄存器，32bit。 <!-- GOTO --></li>
</ul></li>
<li>MODULE_CSRB
<ul>
<li>控制寄存器，32bit。 <!-- GOTO --></li>
</ul></li>
<li>MODULE_FORMATE
<ul>
<li>当前无用。</li>
</ul></li>
<li>RUN_TYPE
<ul>
<li><ol start="0" style="list-style-type: decimal">
<li><ul>
<li>slow control run, 0x100 - list mode runs, 0x301 - MCA run</li>
</ul></li>
</ol></li>
</ul></li>
<li>COINCIDENCE_PATTERN
<ul>
<li>32bit。位模式，用来指定所需通道之间的符合。</li>
</ul></li>
<li>SYNCH_WAIT
<ul>
<li>用来控制不同插件是否同时开始获取数据。</li>
<li>1 - 同时；0 - 不同时。</li>
</ul></li>
<li>IN_SYNCH
<ul>
<li>用来控制是否做时间同步。</li>
<li>0 - 同步；1 - 不同步。</li>
</ul></li>
<li>SLOW_FILTER_RANGE
<ul>
<li><!-- GOTO --></li>
<li>参数范围：1 - 6</li>
</ul></li>
<li>FAST_FILTER_RANGE
<ul>
<li><!-- GOTO --></li>
<li>指定参数：0</li>
</ul></li>
<li>HOST_RT_PRESET
<ul>
<li>预设采集时间。仅适用于 MCA mode run。</li>
</ul></li>
</ul>
<h2 id="module-parametersoutput">Module Parameters(Output)</h2>
<ul>
<li>RUN_TIME
<ul>
<li>数据获取时间，单位：s</li>
</ul></li>
<li>NUMBER_EVENTS
<ul>
<li>上一轮获取事件数。</li>
</ul></li>
<li>BOARD_VERSION
<ul>
<li>不详。</li>
</ul></li>
<li>SERIAL_NUMBER
<ul>
<li>不详。</li>
</ul></li>
</ul>
<h2 id="channel-parameterinput">Channel Parameter(Input)</h2>
<ul>
<li>CHANNEL_CSRA
<ul>
<li>控制寄存器，32bit。 <!-- GOTO --></li>
</ul></li>
<li>CHANNEL_CSRB
<ul>
<li>控制寄存器，32bit。 <!-- GOTO --></li>
</ul></li>
<li>CFD_THRESHOLD
<ul>
<li>不详。</li>
</ul></li>
<li>PSA_START
<ul>
<li>不详。</li>
</ul></li>
<li>PSA_END
<ul>
<li>不详。</li>
</ul></li>
<li>INTEGRATOR
<ul>
<li>不详。</li>
</ul></li>
<li>XDT
<ul>
<li>示波器监视下的ADC采样之间的时间间隔。</li>
</ul></li>
</ul>
<p>以下是当前可设置参数：</p>
<ul>
<li>VOFFSET[Analog Signal Setup: DCOffset]
<ul>
<li>输入信号偏置</li>
<li>参数范围： -1.5V - 1.5V</li>
</ul></li>
<li>[Analog Signal Setup: Gain Sign]
<ul>
<li>同CHANCSRA Bit 14</li>
</ul></li>
<li>ENERGY_RISETIME[Energy Filter: TPeaking]
<ul>
<li>T形算法的上升时间</li>
<li>参数范围： <span class="math">2 ⋅ 2<sup><em>S</em><em>L</em><em>O</em><em>W</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup> ⋅ 10<em>n</em><em>s</em></span> - <span class="math">124 * 2<sup><em>S</em><em>L</em><em>O</em><em>W</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup> * 10<em>n</em><em>s</em></span></li>
</ul></li>
<li>ENERGY_FLATTOP[Energy Filter: TGap]
<ul>
<li>T形算法的平台时间</li>
<li>参数范围： <span class="math">3 * 2<sup><em>S</em><em>L</em><em>O</em><em>W</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup> * 10<em>n</em><em>s</em></span> - <span class="math">125 * 2<sup><em>S</em><em>L</em><em>O</em><em>W</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup> * 10<em>n</em><em>s</em></span></li>
</ul></li>
<li>TRIGGER_RISETIME[Triger Filter: TPeaking]
<ul>
<li>T形算法的上升时间</li>
<li>参数范围： 10ns - 63*10ns</li>
</ul></li>
<li>TRIGGER_FLATTOP[Triger Filter: TGap]
<ul>
<li>T形算法的平台时间</li>
<li>参数范围： 0 - 63*10ns</li>
</ul></li>
<li>TRIGGER_THRESHOLD[Triger Filter: Thresh]
<ul>
<li>该数值为trigger filter的阈值。当trigger filter输出大于该数值时，信号便被触发。</li>
<li>参数范围： 0 - 16383</li>
</ul></li>
<li>TRACE_LENGTH[Pulse Shape: Trace Length]
<ul>
<li>获取波形的总长度</li>
<li>参数范围： 0 - 81.92us，10ns一个采样点</li>
</ul></li>
<li>TRACE_DELAY[Pulse Shape: Trace Delay]
<ul>
<li>获取波形在触发前的长度</li>
<li>参数范围： 0 - 10.24us，10ns一个采样点</li>
</ul></li>
<li>BLCUT[Baseline Setup： BL Cut]<em>该参数没理解</em>
<ul>
<li>该变量用来设置基线的截断阈值在基线测量中。如果该数值不为0，DSP将会持续地检查计算出的每个基线数值是否超出设定的BLCUT限制。如果基线数值在限制范围内，他将用来计算平均值；反之，它将被抛弃。将BLCUT设为0将不检查基线，这样可减少处理时间。</li>
</ul></li>
<li>BASELINE_PERCENT[Baseline Setup：Baseline]
<ul>
<li>该参数设置数字信号的偏置，让其自动调整到满量程的百分比处。例如满量程是16383，该数值设为10，那么信号的基线将自动调整到1638附近。</li>
<li>参数范围： 0 - 100</li>
</ul></li>
<li>TAU[Decay Time： Tau]
<ul>
<li>该数值为前放的指数衰减时间。它是DSP计算能量的参数之一，因此其输入的准确性将影响计算出能量的准确性。</li>
<li>该参数单位：us</li>
</ul></li>
</ul>
<p>下面两个只适用于MCA mode</p>
<ul>
<li>EMIN[Histograming： EMin]
<ul>
<li>能量值为16位的精度。</li>
<li>MCA的最小能量，计算出来的能量都会减去该数值再填充到谱上。因此 bin 0 即为 EMIN。</li>
<li>参数范围： 0 - 65535</li>
</ul></li>
<li>BINFACTOR[Histograming： Bin Factor]
<ul>
<li>该数值用来控制直方图分bin个数。每个bin对应的能量为<span class="math"><em>M</em><em>C</em><em>A</em><em>b</em><em>i</em><em>n</em> = (<em>E</em><em>n</em><em>e</em><em>r</em><em>g</em><em>y</em> − <em>E</em><em>M</em><em>I</em><em>N</em>) ⋅ 2<sup> − <em>B</em><em>I</em><em>N</em><em>F</em><em>A</em><em>C</em><em>T</em><em>O</em><em>R</em></sup></span></li>
<li>参数范围： 1 - 16</li>
</ul></li>
</ul>
<h2 id="channel-parametersoutput">Channel Parameters(Output)</h2>
<ul>
<li>LIVE_TIME
<ul>
<li>该通道的活时</li>
</ul></li>
<li>FAST_PEAKS
<ul>
<li>该通道的 fast trigger 事件数</li>
</ul></li>
<li>INPUT_COUNT_RATE
<ul>
<li>该通道的输入计数率</li>
</ul></li>
<li>OUTPUT_COUNT_RATE
<ul>
<li>该通道的输出计数率</li>
</ul></li>
<li>EVENT_RATE
<ul>
<li>该插件的事件处理速率</li>
</ul></li>
</ul>
<hr />
<h1 id="dsp-parmeters">DSP Parmeters</h1>
<h2 id="module-input-parameters">Module input parameters</h2>
<ul>
<li>MODNUM
<ul>
<li>见 API 中的MODULE_NUMBER。</li>
</ul></li>
<li>MODCSRA <strong>重要</strong>
<ul>
<li>Bit 0 : If set,connect module trigger lines to backplane.Triggers will be shared with other modules.If not set,triggers are distributed only between channels of this module,depending on channel settings.</li>
<li>Bit 1-31 : 预留。</li>
</ul></li>
<li>MODCSRB <strong>重要</strong>
<ul>
<li>Bit 0 : If set,wired-OR trigger lines on the backplane connect to a pullup resistor.This bit should be set for only one module in the backplane segment.</li>
<li>Bit 1 : If set,trigger lines in the J2 connector connect to the backplane.</li>
<li>Bit 2 : If set,the module is a trigger master that issues and receives triggers from the backplane.Several modules can be set as trigger masters.If not set,the module only receives triggers from the backplane.</li>
<li>Bit 3-31 : 预留。</li>
</ul></li>
<li>MODFORMAT
<ul>
<li>见 API 中的MODULE_FORMATE。</li>
</ul></li>
<li>CHANNUM
<ul>
<li>通道编号。</li>
</ul></li>
<li>RUNTASK
<ul>
<li>运行模式。当前支持三种模式，见 API 中的RUN_TYPE。</li>
</ul></li>
<li>CONTROLTASK
<ul>
<li>Use this variable to select a control task.Consult the control tasks section of this manual for detailed information.The control task will be launched when you issue a run start command with RUNTASK=0.</li>
</ul></li>
<li>MAXEVENTS
<ul>
<li>如果该插件获取事件数到达该数值，则停止获取。将MaxEvents设置为0则关闭该功能。</li>
</ul></li>
<li>COINCPATTERN
<ul>
<li>The user can request that certain coincidence/anticoincidence patterns are found for the event to be accepted.</li>
</ul></li>
<li>COINCWAIT
<ul>
<li>Duration of the cioncidence time window in clock ticks(each clock tick spans 10ns)</li>
</ul></li>
<li>SYNCHWAIT
<ul>
<li>见 API 中的SYNCH_WAIT。</li>
</ul></li>
<li>INSYNCH
<ul>
<li>见 API 中的IN_SYNCH。</li>
</ul></li>
<li>HOSTIO
<ul>
<li>A 4 word data block that is used to specify command options.</li>
</ul></li>
<li>RESUME
<ul>
<li>Set this variable to 1 to resume a data run;otherwise,set it to 0.</li>
</ul></li>
<li>SLOWFILTERRANGE
<ul>
<li>The energy filter range downloaded from the host to the DSP and FPGA.It sets the number of ADC samples(<span class="math">2<sup><em>S</em><em>L</em><em>O</em><em>W</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup></span>)to be averaged before entering the energy filtering logic.The currently supported filter range in the signal processing FPGA includes 1,2,3,4,5,6.</li>
</ul></li>
<li>FASTFILTERRANGE
<ul>
<li>The trigger filter range downloaded from the host to the DSP and FPGA.It sets the number of ADC samples(<span class="math">2<sup><em>F</em><em>A</em><em>S</em><em>T</em><em>F</em><em>I</em><em>L</em><em>T</em><em>E</em><em>R</em><em>R</em><em>A</em><em>N</em><em>G</em><em>E</em></sup></span>)to be averaged before entering the trigger filtering logic.The currently supported filter range in the signal processing FPGA is only 0.</li>
</ul></li>
<li>U00
<ul>
<li>预留。</li>
</ul></li>
<li>USERIN
<ul>
<li>A block of 16 input variables used by user-written DSP code.</li>
</ul></li>
</ul>
<h2 id="channel-input-parameters">Channel input parameters</h2>
<ul>
<li>CHANCSRB
<ul>
<li>Bit 0-15 : 预留，全部设为0。</li>
</ul></li>
<li>GAINDAC
<ul>
<li>Reserved and not supported.</li>
</ul></li>
<li>OFFSETDAC
<ul>
<li>This DAC determines the DC-offset voltage.The offset can be calculated using the following formula: Offset[V] = 1.5*((32768-TRACKDAC)/32768)</li>
</ul></li>
<li>DIGGAIN
<ul>
<li>The digital gain factor for compensating the difference between the user desired voltage gain and the SGA gain.</li>
</ul></li>
<li>UNUSEDA0
<ul>
<li>预留。</li>
</ul></li>
<li>UNUSEDA1
<ul>
<li>预留。</li>
</ul></li>
</ul>
<p>以下是当前可设置参数：</p>
<ul>
<li>CHANCSRA
<ul>
<li>Bit 2 : Good channel
<ul>
<li>此项控制是否开启该路获取。</li>
</ul></li>
<li>Bit 5 : Trigger positive
<ul>
<li>选择此项表示正斜率触发，清除此项表示负斜率触发。trigger/filter FPGA只能处理正信号，对负信号将会先作反相处理之后再送入FPGA。</li>
</ul></li>
<li>Bit 7 : Histogram energy
<ul>
<li>此项控制是否在插件MCA内存中记录能量直方图。</li>
</ul></li>
<li>Bit 8 : Enable trace capture
<ul>
<li>此项控制是否记录波形。</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 9 : Enable QDC sums capture
<ul>
<li>此项控制是否记录QDC sums。</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 10 : Enable CFD trigger mode
<ul>
<li>此项控制是否开启CFD trigger mode。</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 11 : Enable global trigger validation
<ul>
<li>此项控制是否开启global trigger for events validation for this channel。</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 12 : Enable capture raw energy sums and baselines
<ul>
<li>此项控制是否记录raw energy sums和baselines</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 13 : Enable channel trigger validation
<ul>
<li>此项控制是否开启channel trigger for events validation for this channel。</li>
<li>1-enable 0-disable</li>
</ul></li>
<li>Bit 14 : Enable input relay</li>
<li>This bit controls the input relay of the Pixie-16,switching between high and low gain or connecting/disconnecting the input.The function depends on the input specifications for your particular bardware.</li>
<li>Bit 15 : Pileup rejection control
<ul>
<li>此项控制是否开启堆积拒绝。</li>
<li>1-enable 0-disable</li>
</ul></li>
</ul></li>
</ul>
<!-- | a | b | c | -->
<!-- | :--- | :--- | :--- | -->
<!-- | 1 | 2 | 3 | -->
<!-- | 4 | 5 | 6 | -->


<!-- README.md ends here -->
</body>
</html>
